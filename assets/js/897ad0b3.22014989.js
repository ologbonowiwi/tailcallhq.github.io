"use strict";(self.webpackChunkmy_website=self.webpackChunkmy_website||[]).push([[8985],{9259:(e,t,s)=>{s.r(t),s.d(t,{assets:()=>c,contentTitle:()=>o,default:()=>h,frontMatter:()=>i,metadata:()=>a,toc:()=>l});var n=s(5893),r=s(1151);const i={title:"HTTP Filters",description:"Modify upstream requests and responses using Javascript"},o=void 0,a={id:"guides/http-filters",title:"HTTP Filters",description:"Modify upstream requests and responses using Javascript",source:"@site/docs/guides/http-filters.md",sourceDirName:"guides",slug:"/guides/http-filters",permalink:"/docs/guides/http-filters",draft:!1,unlisted:!1,editUrl:"https://github.com/tailcallhq/tailcallhq.github.io/tree/develop/docs/guides/http-filters.md",tags:[],version:"current",frontMatter:{title:"HTTP Filters",description:"Modify upstream requests and responses using Javascript"},sidebar:"tutorialSidebar",previous:{title:"Http Cache",permalink:"/docs/guides/http-cache"},next:{title:"Logging",permalink:"/docs/guides/logging"}},c={},l=[{value:"Getting Started",id:"getting-started",level:2},{value:"Modify Request",id:"modify-request",level:2},{value:"Create Response",id:"create-response",level:2},{value:"Response Redirect",id:"response-redirect",level:2},{value:"Schema",id:"schema",level:2},{value:"Request",id:"request",level:3},{value:"Response",id:"response",level:3}];function d(e){const t={a:"a",admonition:"admonition",code:"code",h2:"h2",h3:"h3",p:"p",pre:"pre",...(0,r.a)(),...e.components};return(0,n.jsxs)(n.Fragment,{children:[(0,n.jsx)(t.p,{children:"Tailcall provides a light-weight JS runtime to modify requests and resolve with custom responses.\nThe runtime is not a full-fledged Node.js environment and has no access to the file system or the network. It is designed to be used for simple request/response modifications."}),"\n",(0,n.jsx)(t.h2,{id:"getting-started",children:"Getting Started"}),"\n",(0,n.jsxs)(t.p,{children:["To leverage this functionality, a JavaScript function named ",(0,n.jsx)(t.code,{children:"onRequest"})," must be created in a ",(0,n.jsx)(t.code,{children:"worker.js"})," file. This function serves as middleware, allowing for the interception and modification of the request. Here is a simple example of a ",(0,n.jsx)(t.code,{children:"worker.js"})," file that logs the request and returns the original request without any modifications."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-javascript",children:"function onRequest({request}) {\n  console.log(`${request.method} ${request.uri.path}`)\n\n  return {request}\n}\n"})}),"\n",(0,n.jsxs)(t.p,{children:["Once you have a worker file ready, you link that file to the tailcall configuration using the ",(0,n.jsx)(t.a,{href:"/docs/operators/link",children:"@link"})," operator."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-graphql",children:'schema @link(type: Script, src: "./worker.js") {\n  query: Query\n}\n'})}),"\n",(0,n.jsxs)(t.p,{children:["Once the worker is linked, you can start the server using the usual ",(0,n.jsx)(t.a,{href:"/docs/guides/cli/#start",children:"start"})," command. Making requests to tailcall will now be intercepted by the worker and logged to the console."]}),"\n",(0,n.jsx)(t.h2,{id:"modify-request",children:"Modify Request"}),"\n",(0,n.jsxs)(t.p,{children:["You can modify the request by returning a ",(0,n.jsx)(t.code,{children:"request"})," object from the ",(0,n.jsx)(t.code,{children:"onRequest"})," function. Below is an example where we are modifying the request to add a custom header."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-javascript",children:'function onRequest({request}) {\n  request.headers["x-custom-header"] = "Hello, Tailcall!"\n\n  return {request}\n}\n'})}),"\n",(0,n.jsx)(t.h2,{id:"create-response",children:"Create Response"}),"\n",(0,n.jsxs)(t.p,{children:["You can respond with custom responses by returning a ",(0,n.jsx)(t.code,{children:"response"})," object from the ",(0,n.jsx)(t.code,{children:"onRequest"})," function. Below is an example where we are responding with a custom response for all requests that start with ",(0,n.jsx)(t.code,{children:"https://api.example.com"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-javascript",children:'function onRequest({request}) {\n  if (request.uri.path.startsWith("https://api.example.com")) {\n    return {\n      response: {\n        status: 200,\n        headers: {\n          "content-type": "application/json"\n        },\n        body: JSON.stringify({message: "Hello, Tailcall!"})\n      }\n    }\n  }\n  else {\n    return {request}\n  }\n'})}),"\n",(0,n.jsx)(t.h2,{id:"response-redirect",children:"Response Redirect"}),"\n",(0,n.jsxs)(t.p,{children:["Sometimes you might want to redirect the request to a different URL. You can do this by returning a ",(0,n.jsx)(t.code,{children:"response"})," object with a ",(0,n.jsx)(t.code,{children:"status"})," of ",(0,n.jsx)(t.code,{children:"301"})," or ",(0,n.jsx)(t.code,{children:"302"})," and a ",(0,n.jsx)(t.code,{children:"Location"})," header. The following example redirects all requests to ",(0,n.jsx)(t.code,{children:"https://example.com"})," to ",(0,n.jsx)(t.code,{children:"https://tailcall.com"}),"."]}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-javascript",children:'function onRequest({request}) {\n  if (request.uri.path.startsWith("https://example.com")) {\n    return {\n      response: {\n        status: 301,\n        headers: {\n          Location: "https://tailcall.com",\n        },\n      },\n    }\n  } else {\n    return {request}\n  }\n}\n'})}),"\n",(0,n.jsx)(t.admonition,{type:"important",children:(0,n.jsx)(t.p,{children:"The new request that's created as a result of the redirect will not be intercepted by the worker."})}),"\n",(0,n.jsx)(t.h2,{id:"schema",children:"Schema"}),"\n",(0,n.jsxs)(t.p,{children:["The ",(0,n.jsx)(t.code,{children:"onRequest"})," function takes a single argument that contains the request object. The return value of the ",(0,n.jsx)(t.code,{children:"onRequest"})," function can be a ",(0,n.jsx)(t.code,{children:"request"})," object, or a ",(0,n.jsx)(t.code,{children:"response"})," object. It can not be null or undefined."]}),"\n",(0,n.jsx)(t.h3,{id:"request",children:"Request"}),"\n",(0,n.jsx)(t.p,{children:"The request object has the following shape:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-typescript",children:'type Request = {\n  method: string\n  uri: {\n    path: string\n    query?: {[key: string]: string}\n    scheme: "Http" | "Https"\n    host?: string\n    port?: number\n  }\n  headers: {[key: string]: string}\n  body?: string\n}\n'})}),"\n",(0,n.jsx)(t.admonition,{type:"tip",children:(0,n.jsxs)(t.p,{children:["By default the headers field will be empty in most cases, unless headers are whitelisted via the ",(0,n.jsx)(t.a,{href:"/docs/operators/upstream#allowedheaders",children:"allowedHeaders"})," setting in ",(0,n.jsx)(t.a,{href:"/docs/operators/upstream",children:"@upstream"}),"."]})}),"\n",(0,n.jsx)(t.p,{children:"The http filter doesn't have access to the request's body. However the modified request that's returned can optionally provide the body."}),"\n",(0,n.jsx)(t.h3,{id:"response",children:"Response"}),"\n",(0,n.jsx)(t.p,{children:"The response object has the following shape:"}),"\n",(0,n.jsx)(t.pre,{children:(0,n.jsx)(t.code,{className:"language-typescript",children:"type Response = {\n  status: number\n  headers: {[key: string]: string}\n  body?: string\n}\n"})})]})}function h(e={}){const{wrapper:t}={...(0,r.a)(),...e.components};return t?(0,n.jsx)(t,{...e,children:(0,n.jsx)(d,{...e})}):d(e)}},1151:(e,t,s)=>{s.d(t,{Z:()=>a,a:()=>o});var n=s(7294);const r={},i=n.createContext(r);function o(e){const t=n.useContext(i);return n.useMemo((function(){return"function"==typeof e?e(t):{...t,...e}}),[t,e])}function a(e){let t;return t=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:o(e.components),n.createElement(i.Provider,{value:t},e.children)}}}]);